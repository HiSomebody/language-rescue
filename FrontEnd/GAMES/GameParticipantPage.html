<!-- Begin stream -->
<html>
	<head><script>
		var username;
		var code;
		
		var HttpClient = function() {
		    this.get = function(aUrl, aCallback) {
		        var anHttpRequest = new XMLHttpRequest();
		        anHttpRequest.onreadystatechange = function() { 
		            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
		                aCallback(anHttpRequest.responseText);
		        }

		        anHttpRequest.open( "GET", aUrl, true );            
		        anHttpRequest.send( null );
		    }
			this.post = function(aUrl, aCallback) {
			var xhttp = new XMLHttpRequest();
			  xhttp.onreadystatechange = function() {
			    if (this.readyState == 4 && this.status == 200) {
			      	aCallback(xhttp.responseText);
			    }
			  };
			  xhttp.open("POST", aUrl, true);
			  xhttp.send();
		  }
		}
		
		
		
		function initializeGame(players)
		{
			var playersDiv = document.getElementById("playersDiv");
			
			for (var i = 0; i < players.length; i++)
			{
				var playerDiv = document.createElement("div");
				var nameLbl = document.createTextNode(players[i].name + ": ");
				var message = document.createTextNode(players[i].text);
				playerDiv.setAttribute("id","player"+players[i].name);
				var imgDiv = document.createElement("img");
				imgDiv.height=50;
				imgDiv.src = players[i].image;
				//tagLineDiv.setAttribute("text-align","center");
				imgDiv.setAttribute("id","img"+players[i].name);
				playerDiv.appendChild(imgDiv);
				playerDiv.appendChild(nameLbl);
				playerDiv.appendChild(message);
				playersDiv.appendChild(playerDiv);
			}
		}
		
		window.onload = function()
		{
			code = GetURLParameter("gameCode");
			console.log("Code: " + code);
			document.getElementById("GameCodeHeader").innerHTML = "Game Code: " + code;
			username = GetURLParameter("username");
			console.log("user name: " + username);
			document.getElementById("NameHeader").innerHTML = "Name: " + username;
			window.history.replaceState('', 'Game Hub', '/test');
		
			var client = new HttpClient();
			client.get('http://104.236.169.62:80/loadGameForClient/'+code, function(response) {
				var parsedJSON = (JSON.parse(response));
			    console.log(parsedJSON["players"]);
				if (parsedJSON["result"] == "success")
				{
					initializeGame(parsedJSON['players']);
				}
				else
				{
					document.removeChild(document.documentElement);
					var playerDiv = document.createElement("div");
					var message = document.createTextNode(parsedJSON["err"]);
					playerDiv.appendChild(message);
					document.appendChild(playerDiv);
				}
			});	
		}
		
		
		var GetURLParameter = function(sParam)
		{
			var sPageURL = window.location.search.substring(1);
			console.log("URL to check: " + sPageURL);
			var sURLVariables = sPageURL.split('&');
			for (var i = 0; i < sURLVariables.length; i++) 
			{
				var sParameterName = sURLVariables[i].split('=');
				if (sParameterName[0] == sParam) 
				{
					return sParameterName[1];
				}
			}
		}
		
		function updateGame(players)
		{
			
		}
		
		function changeAvatar()
		{
			var src = document.getElementById("srcInputField").value;
			var client = new HttpClient();
			client.post('http://104.236.169.62:80/setClientImageUrl/'+code+'/'+username+'/'+src, function(response) {
				var parsedJSON = (JSON.parse(response));
			    //console.log(parsedJSON);
				if (parsedJSON["result"] == "success")
				{
					document.getElementById("img"+username).src = src;
					var players = parsedJSON['players'];
					updateGame(players);
				}
				else
				{
					var failedDiv = document.createElement("div");
					var message = document.createTextNode(parsedJSON["err"]);
					failedDiv.appendChild(message);
					document.appendChild(failedDiv);
				}
			});	
		}
		
		function changeMessage()
		{
			var message = document.getElementById("chatInputField").value;
			var client = new HttpClient();
			client.post('http://104.236.169.62:80/setClientMessage/'+code+'/'+username+'/'+message, function(response) {
				var parsedJSON = (JSON.parse(response));
			    //console.log(parsedJSON);
				if (parsedJSON["result"] == "success")
				{
					document.getElementById("player"+username).childNodes[2].nodeValue = message;
					var players = parsedJSON['players'];
					updateGame(players);
				}
				else
				{
					var failedDiv = document.createElement("div");
					var message = document.createTextNode(parsedJSON["err"]);
					failedDiv.appendChild(message);
					document.appendChild(failedDiv);
				}
			});	
			
			
		}
		
		
		
		</script>
	</head>
	<body>
		<h2 id="GameCodeHeader">Game Code:</h2>
		<h2 id="NameHeader">Name:</h2>
		<div style="text-align:center" id="gameDiv">
			<div id="playersDiv"></div>
			<br>
			<input placeholder="Type Message" id="chatInputField"/>
			<button onclick="changeMessage()">Send</button>
			<br><br>
			<input placeholder="avatar img URL" id="srcInputField"/>
			<button onclick="changeAvatar()">Change Avatar</button>
			
		</div>
	</body>
</html>

<!-- End stream -->